name: drupal9
recipe: drupal9
excludes:
  - .
config:
  webroot: web
  php: '8.1'
  composer_version: '2'
  drush: false
  xdebug: debug
  database: mariadb
services:
  # appserver
  appserver:
    portforward: false
    overrides:
      environment:
        PHP_MEMORY_LIMIT: 128M
    build_as_root:
      - apt-get update && apt-get install -y mc net-tools iputils-ping
      - rm -f /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 start && /etc/init.d/apache2 reload
      - cd /tmp && git clone https://github.com/longxinH/xhprof.git
      - cd /tmp/xhprof/extension && phpize && ./configure && make && make install
      - echo 'extension=xhprof.so' > /usr/local/etc/php/conf.d/xhprof.ini
    build:
      - curl https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash -o ~/.git-completion.bash
      - curl https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh -o ~/.git-prompt.sh
      - ln -sf /app/.lando/.bashrc /var/www/.bashrc
  # varnish
  varnish:
    type: varnish:6
    backends:
      - appserver
    backend_port: 80
    overrides:
      environment:
        VARNISH_ALLOW_UNRESTRICTED_PURGE: 1
    config:
      vcl: .lando/varnish/default.vcl
  # database
  database:
    type: compose
    services:
      image: mariadb
      command: docker-entrypoint.sh mysqld
      entrypoint: docker-entrypoint.sh
      environment:
        - MARIADB_ROOT_PASSWORD=root
        - MARIADB_DATABASE=drupal
        - MARIADB_USER=drupal
        - MARIADB_PASSWORD=drupal
      volumes:
        - database_volume:/var/lib/mysql
    volumes:
      database_volume:
  # phpmyadmin
  phpmyadmin:
    type: phpmyadmin
    overrides:
      environment:
        - PMA_PASSWORD=root
  # memcached
  memcached:
    type: memcached:custom
    overrides:
      image: memcached
      command: ["-m", "4096"]
      entrypoint: memcached
  # solr
  solr:
    type: solr
    core: collection1
    config:
      dir: .lando/solr
  # elasticsearch
  elasticsearch:
    type: compose
    portforward: true
    app_mount: false
    services:
      image: elasticsearch:7.17.5
      command: ["/bin/tini", "--", "/usr/local/bin/docker-entrypoint.sh", "eswrapper"]
      environment:
        - node.name=drupal-es01
        - cluster.name=drupal-es01-docker-cluster
        - cluster.initial_master_nodes=drupal-es01
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms128m -Xmx128m"
        - http.cors.enabled=true
        - http.cors.allow-origin=/.*/
      ulimits:
        memlock:
          soft: -1
          hard: -1
      volumes:
        - es_volume:/usr/share/elasticsearch/data
    volumes:
      es_volume:
tooling:
  blt:
    service: appserver
    cmd: /app/vendor/bin/blt
  node:
    service: appserver
  npm:
    service: appserver
  xdebug-on:
    service: appserver
    description: Enable xdebug for apache.
    cmd: "docker-php-ext-enable xdebug && /etc/init.d/apache2 reload"
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for apache.
    cmd: "rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 reload"
    user: root
proxy:
  appserver:
    - drupal9.lndo.site
  varnish:
    - varnish.drupal9.lndo.site
  phpmyadmin:
    - pma.drupal9.lndo.site
  solr:
    - solr.drupal9.lndo.site:8983
  elasticsearch:
    - elasticsearch.drupal9.lndo.site:9200
