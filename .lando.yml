name: lando-demo
recipe: drupal10
excludes:
  - .
config:
  webroot: web
  php: '8.3'
  composer_version: '2'
  drush: false
  xdebug: false
env_file:
  - .lando/lando.env

services:
  # appserver [image: devwithlando/php:8.3-apache-5]
  appserver:
    ssl: false
    portforward: false
    scanner: false
    overrides:
      image: ''  # Clear the default image
      build:
        context: ./.lando/appserver
        dockerfile: Dockerfile
      environment:
        PHP_MEMORY_LIMIT: 128M

  # varnish [image: varnish:7.5]
  varnish:
    type: compose
    portforward: false
    scanner: false
    app_mount: false
    services:
      build:
        context: ./.lando/varnish
      command: ["varnishd", "-F", "-f", "/etc/varnish/default.vcl", "-p", "http_req_hdr_len=16384", "-p", "http_resp_hdr_len=16384", "-s", "default,64M"]

  # database overriden
  database:
    type: compose
    ssl: false
    portforward: false
    scanner: false
    app_mount: false
    healthcheck: false
    services:
      image: mariadb:10.6.23
      command: docker-entrypoint.sh mysqld
      entrypoint: docker-entrypoint.sh
      environment:
        - MARIADB_ROOT_PASSWORD=root
        - MARIADB_DATABASE=drupal
        - MARIADB_USER=drupal
        - MARIADB_PASSWORD=drupal
      volumes:
        - data_database:/var/lib/mysql
    volumes:
      data_database:

  # phpmyadmin
  phpmyadmin:
    type: phpmyadmin
    ssl: false
    portforward: false
    scanner: false
    app_mount: false
    overrides:
      image: phpmyadmin:5.2.2
      environment:
        - PMA_PASSWORD=root

  # memcached
  memcached:
    type: memcached
    ssl: false
    portforward: false
    scanner: false
    app_mount: false
    overrides:
      image: memcached:1.6.39
      command: ["-m", "64"]
      entrypoint: memcached

  # # solr
  solr:
    type: solr:8
    ssl: false
    portforward: false
    scanner: false
    app_mount: false
    healthcheck: false
    core: collection1
    config:
      dir: .lando/solr/config
    overrides:
      environment:
        SOLR_HEAP: "384m"
      deploy:
        resources:
          limits:
            memory: 512m
      mem_limit: 512m

  # # elasticsearch
  elasticsearch:
    type: elasticsearch:8
    ssl: false
    portforward: false
    scanner: false
    app_mount: false
    healthcheck: false
    overrides:
      environment:
        - node.name=drupal-es01
        - cluster.name=drupal-es01-docker-cluster
        - cluster.initial_master_nodes=drupal-es01
        - bootstrap.memory_lock=true
        - "ES_JAVA_OPTS=-Xms128m -Xmx128m"
        - http.cors.enabled=true
        - http.cors.allow-origin=/.*/

tooling:
  node:
    service: appserver
  npm:
    service: appserver
  xdebug-on:
    service: appserver
    description: Enable xdebug for apache.
    cmd: "docker-php-ext-enable xdebug && /etc/init.d/apache2 reload"
    user: root
  xdebug-off:
    service: appserver
    description: Disable xdebug for apache.
    cmd: "rm /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini && /etc/init.d/apache2 reload"
    user: root
proxy:
  appserver:
    - lando-demo.lndo.site
  varnish:
    - varnish.lando-demo.lndo.site
  phpmyadmin:
    - pma.lando-demo.lndo.site
  solr:
    - solr.lando-demo.lndo.site:8983
  elasticsearch:
    - elasticsearch.lando-demo.lndo.site:9200
